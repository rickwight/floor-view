<!DOCTYPE html>
<html>
<head>
  <title>floor-view</title>
  <style>

  body {
      background-color: white;
  }

  </style>
</head>
<body>

<script type="text/javascript" src="./js/jquery-1.8.2.js"></script>
<script type="text/javascript" src="./js/jquery.mousewheel.js"></script>
<script type="text/javascript" src="./js/d3.v2.js"></script>
<script type="text/javascript" src="./js/RequestAnimationFrame.js"></script>
<script type="text/javascript" src="./js/three.js"></script>
<script type="text/javascript" src="./js/d3gl.js"></script>
<script type="text/javascript" src="./js/jquery.csv-0.71.min.js"></script>

<div id="the-input">
  <button type="button" id="the-graph-button">Graph!</button>
  <textarea id="the-input-textarea" rows="10" cols="50">
34.858959,-21.473159,30.003743
34.843719,-21.056599,30.003743
34.716719,-20.624799,30.003743
34.716719,-20.142199,30.003743
34.676079,-19.649439,30.003743
  </textarea>
</div>
<div id="the-graph"></div>


<script type="text/javascript">
function arrToHash(arr) {
  obj = [];
  for (var i = 0; i < arr.length; i++) {
    h = {};
    h['x'] = arr[i][0];
    h['y'] = arr[i][1];
    h['z'] = arr[i][2];
    obj.push(h);
  }
  return obj;
}

function printVerts(verts) {
  for (var i = 0; i < verts.length; i++) {
    console.log(verts[i]);
  }
}

function drawGraph() {
  width = $(window).width();
  height = $(window).height();
  points = window.points;

  console.log('draw: ' + width + ' x ' + height);

  var graph = d3.gl.graph()
    .width(width)
    .height(height);

  var pointcloud = graph.points()
    .data(points)
    .size(5)
    .color(function(d, i) {
      if (i > 50000) return 0x995555;
      else return 0x559999;
      //return scaleColor(vIdx);
    });

  var scales = {
    "x": d3.scale.linear().domain([-40, 40]),
    "y": d3.scale.linear().domain([-40, 40]),
    "z": d3.scale.linear().domain([0, 20])
  };

  var axis = graph.axis()
    .data(["x", "y", "z"])
    .scale(function(d) { return scales[d]; })
    .orient(function(d) { return d; })
    .thickness(1)
    .color("#00f");

  var ticks = axis.ticks()
    .count(function(d) {
      if (d=="z") return 1;
      else return 4;
    })
    .font("16px Arial")
    .size(50)
    .resolution(64);

  var label = axis.label()
    .size(100)
    .resolution(128)
    .font("bold 20px Helvetica")
    .color("#00f");

  var the_graph = d3.select("#the-graph")[0][0];
  console.log("the_graph.childNodes: " + the_graph.childNodes);
  if (the_graph.childNodes.length > 0) {
    d3.selectAll(the_graph.childNodes).remove();
  }
  d3.select("#the-graph").call(graph);
}

function strToNum_point(point) {
  var new_point = [];
  for (var i = 0; i < point.length; i++) {
    new_point.push(parseFloat(point[i]));
  }
  return new_point;
}
function strToNum_points(points) {
  var new_points = [];
  for (var i = 0; i < points.length; i++) {
    new_points.push(strToNum_point(points[i]));
  }
  return new_points;
}
function time_ms() {
  return new Date().getTime();
}

function initPoints() {
  csv = $("#the-input-textarea").val();
  points = $.csv.toArrays(csv);
  points = strToNum_points(points);
  points = arrToHash(points);
  //printVerts(points);
  console.log('num points: ' + points.length);

  window.points = points;
}

$(document).ready(function() {
  initPoints()
  drawGraph();
});

$("#the-graph-button").click(function() {
  initPoints();
  drawGraph();
});

$(window).resize(function() {
  // only draw if we stop resizing for a specified period
  clearTimeout(window.timeout_last_resize);
  window.timeout_last_resize = setTimeout(function() {
    drawGraph();
  }, 500);
});

</script>
</body>
</html>
