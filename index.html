<!DOCTYPE html>
<html>
<head>
  <title>floor-view</title>
  <style>

  body {
      background-color: white;
  }

  </style>
</head>
<body>

<script type="text/javascript" src="./js/jquery-1.8.2.js"></script>
<script type="text/javascript" src="./js/jquery.mousewheel.js"></script>
<script type="text/javascript" src="./js/d3.v2.js"></script>
<script type="text/javascript" src="./js/RequestAnimationFrame.js"></script>
<script type="text/javascript" src="./js/three.js"></script>
<script type="text/javascript" src="./js/d3gl.js"></script>
<script type="text/javascript" src="./js/jquery.csv-0.71.min.js"></script>

<div id="the-input">
  <button type="button" id="the-graph-button">Graph!</button>
  <textarea id="the-input-textarea" rows="10" cols="50">
0,0,0
0,0,1
0,1,0
0,1,1
1,0,0
1,0,1
1,1,0
1,1,1</textarea>
</div>
<div id="the-graph"></div>


<script type="text/javascript">

function drawGraph() {
  width = $(window).width() / 2;
  height = $(window).height() / 2;
  points = window.points;

  console.log('draw: ' + width + ' x ' + height);

  var graph = d3.gl.graph()
    .width(width)
    .height(height);

  var pointcloud = graph.points()
    .data(points)
    .size(5)
    .color(function(d, i) {
      if (i > 50000) return 0x995555;
      else return 0x559999;
      //return scaleColor(vIdx);
    });

  var scales = {
    "x": d3.scale.linear().domain([0, 40]),
    "y": d3.scale.linear().domain([0, 40]),
    "z": d3.scale.linear().domain([0, 20])
  };

  var axis = graph.axis()
    .data(["x", "y", "z"])
    .scale(function(d) { return scales[d]; })
    .orient(function(d) { return d; })
    .thickness(1)
    .color("#00f");

  var ticks = axis.ticks()
    .count(function(d) {
      if (d=="z") return 1;
      else return 4;
    })
    .font("16px Arial")
    .size(50)
    .resolution(64);

  var label = axis.label()
    .size(100)
    .resolution(128)
    .font("bold 20px Helvetica")
    .color("#00f");

  var the_graph = d3.select("#the-graph")[0][0];
  console.log("the_graph.childNodes: " + the_graph.childNodes);
  if (the_graph.childNodes.length > 0) {
    d3.selectAll(the_graph.childNodes).remove();
  }
  d3.select("#the-graph").call(graph);
}

function parseInput(input) {
  var points = $.csv.toArrays(input);

  var scale = {
    'x' : 2,
    'y' : 4,
    'z' : 8,
  }

  var translate = {
    'x' : 2,
    'y' : 4,
    'z' : 8,
  }

  var new_points = [];
  for (var p = 0; p < points.length; p++) {
    var new_point = {};
    new_point['x'] = parseFloat(points[p][0]);
    new_point['y'] = parseFloat(points[p][1]);
    new_point['z'] = parseFloat(points[p][2]);
    new_point = transformPoint(new_point, scale, translate);
    new_points.push(new_point);
  }

  printPoints(new_points);
  return new_points;
}

function transformPoint(point, scale, translate) {
  point['x'] *= scale['x'];
  point['y'] *= scale['y'];
  point['z'] *= scale['z'];

  point['x'] += translate['x'];
  point['y'] += translate['y'];
  point['z'] += translate['z'];

  return point;
}

function printPoints(points) {
  for (var i = 0; i < points.length; i++) {
    console.log(points[i]);
  }
}

function time_ms() {
  return new Date().getTime();
}

function initPoints() {
  points = parseInput($("#the-input-textarea").val());
  console.log('num points: ' + points.length);
  window.points = points;
}

$(document).ready(function() {
  initPoints()
  drawGraph();
});

$("#the-graph-button").click(function() {
  initPoints();
  drawGraph();
});

$(window).resize(function() {
  // only draw if we stop resizing for a specified period
  clearTimeout(window.timeout_last_resize);
  window.timeout_last_resize = setTimeout(function() {
    drawGraph();
  }, 500);
});

</script>
</body>
</html>
